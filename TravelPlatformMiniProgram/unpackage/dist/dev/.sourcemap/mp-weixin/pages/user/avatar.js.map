{"version":3,"file":"avatar.js","sources":["pages/user/avatar.vue","E:/HBuilderX/HBuilderX.4.45.2025010502/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvdXNlci9hdmF0YXIudnVl"],"sourcesContent":["<template>\r\n\t<view class=\"container\">\r\n\t\t<view class=\"avatar-preview\">\r\n\t\t\t<image :src=\"currentAvatar\" mode=\"aspectFill\"></image>\r\n\t\t</view>\r\n\t\t\r\n\t\t<view class=\"action-buttons\">\r\n\t\t\t<button class=\"btn\" @click=\"chooseImage\">选择图片</button>\r\n\t\t\t<button class=\"btn primary\" @click=\"uploadAvatar\" :disabled=\"!hasNewImage\">更新头像</button>\r\n\t\t</view>\r\n\t</view>\r\n</template>\r\n\r\n<script>\r\n/**\r\n * 头像预览和更新页面\r\n * @description 用户可以预览和更换头像\r\n */\r\nexport default {\r\n\tdata() {\r\n\t\treturn {\r\n\t\t\tcurrentAvatar: '',\r\n\t\t\ttempFilePath: '',\r\n\t\t\thasNewImage: false\r\n\t\t}\r\n\t},\r\n\tonLoad() {\r\n\t\tconst userInfo = uni.getStorageSync('userInfo')\r\n\t\tif (userInfo) {\r\n\t\t\tthis.currentAvatar = userInfo.avatar\r\n\t\t}\r\n\t},\r\n\tmethods: {\r\n\t\t// 选择图片\r\n\t\tchooseImage() {\r\n\t\t\tuni.chooseImage({\r\n\t\t\t\tcount: 1,\r\n\t\t\t\tsizeType: ['compressed'],\r\n\t\t\t\tsourceType: ['album', 'camera'],\r\n\t\t\t\tsuccess: (res) => {\r\n\t\t\t\t\tthis.tempFilePath = res.tempFilePaths[0]\r\n\t\t\t\t\tthis.currentAvatar = this.tempFilePath\r\n\t\t\t\t\tthis.hasNewImage = true\r\n\t\t\t\t}\r\n\t\t\t})\r\n\t\t},\r\n\t\t\r\n\t\t// 上传头像\r\n\t\tasync uploadAvatar() {\r\n\t\t\tif (!this.hasNewImage) return\r\n\t\t\t\r\n\t\t\ttry {\r\n\t\t\t\tuni.showLoading({\r\n\t\t\t\t\ttitle: '上传中...'\r\n\t\t\t\t})\r\n\t\t\t\t\r\n\t\t\t\t// 上传文件到云存储\r\n\t\t\t\tconst uploadRes = await uniCloud.uploadFile({\r\n\t\t\t\t\tfilePath: this.tempFilePath,\r\n\t\t\t\t\tcloudPath: `avatar/${Date.now()}.jpg`\r\n\t\t\t\t})\r\n\t\t\t\t\r\n\t\t\t\tconst userInfo = uni.getStorageSync('userInfo')\r\n\t\t\t\tif (!userInfo || !userInfo.id) {\r\n\t\t\t\t\tthrow new Error('用户未登录')\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\t// 调用云函数更新头像\r\n\t\t\t\tconst res = await uniCloud.callFunction({\r\n\t\t\t\t\tname: 'update-avatar',\r\n\t\t\t\t\tdata: {\r\n\t\t\t\t\t\tuserId: userInfo.id,\r\n\t\t\t\t\t\tavatar: uploadRes.fileID\r\n\t\t\t\t\t}\r\n\t\t\t\t})\r\n\t\t\t\t\r\n\t\t\t\tif (res.result.code === 0) {\r\n\t\t\t\t\t// 更新本地存储的用户信息\r\n\t\t\t\t\tuserInfo.avatar = res.result.avatar\r\n\t\t\t\t\tuni.setStorageSync('userInfo', userInfo)\r\n\t\t\t\t\t\r\n\t\t\t\t\tuni.showToast({\r\n\t\t\t\t\t\ttitle: '更新成功',\r\n\t\t\t\t\t\ticon: 'success'\r\n\t\t\t\t\t})\r\n\t\t\t\t\t\r\n\t\t\t\t\t// 返回上一页\r\n\t\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\t\tuni.navigateBack()\r\n\t\t\t\t\t}, 1500)\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthrow new Error(res.result.message)\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t} catch (e) {\r\n\t\t\t\tconsole.error('上传头像失败:', e)\r\n\t\t\t\tuni.showToast({\r\n\t\t\t\t\ttitle: '上传失败，请重试',\r\n\t\t\t\t\ticon: 'none'\r\n\t\t\t\t})\r\n\t\t\t} finally {\r\n\t\t\t\tuni.hideLoading()\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n</script>\r\n\r\n<style lang=\"scss\">\r\n.container {\r\n\tpadding: 40rpx;\r\n}\r\n\r\n.avatar-preview {\r\n\twidth: 400rpx;\r\n\theight: 400rpx;\r\n\tmargin: 0 auto 60rpx;\r\n\tborder-radius: 50%;\r\n\toverflow: hidden;\r\n\tbox-shadow: 0 4rpx 16rpx rgba(0,0,0,0.1);\r\n\t\r\n\timage {\r\n\t\twidth: 100%;\r\n\t\theight: 100%;\r\n\t}\r\n}\r\n\r\n.action-buttons {\r\n\t.btn {\r\n\t\twidth: 100%;\r\n\t\theight: 88rpx;\r\n\t\tline-height: 88rpx;\r\n\t\ttext-align: center;\r\n\t\tfont-size: 32rpx;\r\n\t\tcolor: #333;\r\n\t\tbackground-color: #f5f5f5;\r\n\t\tborder-radius: 44rpx;\r\n\t\tmargin-bottom: 30rpx;\r\n\t\t\r\n\t\t&.primary {\r\n\t\t\tcolor: #fff;\r\n\t\t\tbackground-color: #2B9939;\r\n\t\t\t\r\n\t\t\t&[disabled] {\r\n\t\t\t\tbackground-color: #ccc;\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\t&::after {\r\n\t\t\tborder: none;\r\n\t\t}\r\n\t}\r\n}\r\n</style> ","import MiniProgramPage from 'D:/programs2024to2025/ranjiangtaoprogram/first/TravelPlatformMiniProgram/pages/user/avatar.vue'\nwx.createPage(MiniProgramPage)"],"names":["uni","uniCloud"],"mappings":";;AAkBA,MAAK,YAAU;AAAA,EACd,OAAO;AACN,WAAO;AAAA,MACN,eAAe;AAAA,MACf,cAAc;AAAA,MACd,aAAa;AAAA,IACd;AAAA,EACA;AAAA,EACD,SAAS;AACR,UAAM,WAAWA,cAAAA,MAAI,eAAe,UAAU;AAC9C,QAAI,UAAU;AACb,WAAK,gBAAgB,SAAS;AAAA,IAC/B;AAAA,EACA;AAAA,EACD,SAAS;AAAA;AAAA,IAER,cAAc;AACbA,oBAAAA,MAAI,YAAY;AAAA,QACf,OAAO;AAAA,QACP,UAAU,CAAC,YAAY;AAAA,QACvB,YAAY,CAAC,SAAS,QAAQ;AAAA,QAC9B,SAAS,CAAC,QAAQ;AACjB,eAAK,eAAe,IAAI,cAAc,CAAC;AACvC,eAAK,gBAAgB,KAAK;AAC1B,eAAK,cAAc;AAAA,QACpB;AAAA,OACA;AAAA,IACD;AAAA;AAAA,IAGD,MAAM,eAAe;AACpB,UAAI,CAAC,KAAK;AAAa;AAEvB,UAAI;AACHA,sBAAAA,MAAI,YAAY;AAAA,UACf,OAAO;AAAA,SACP;AAGD,cAAM,YAAY,MAAMC,cAAQ,GAAC,WAAW;AAAA,UAC3C,UAAU,KAAK;AAAA,UACf,WAAW,UAAU,KAAK,IAAG,CAAE;AAAA,SAC/B;AAED,cAAM,WAAWD,cAAAA,MAAI,eAAe,UAAU;AAC9C,YAAI,CAAC,YAAY,CAAC,SAAS,IAAI;AAC9B,gBAAM,IAAI,MAAM,OAAO;AAAA,QACxB;AAGA,cAAM,MAAM,MAAMC,cAAQ,GAAC,aAAa;AAAA,UACvC,MAAM;AAAA,UACN,MAAM;AAAA,YACL,QAAQ,SAAS;AAAA,YACjB,QAAQ,UAAU;AAAA,UACnB;AAAA,SACA;AAED,YAAI,IAAI,OAAO,SAAS,GAAG;AAE1B,mBAAS,SAAS,IAAI,OAAO;AAC7BD,8BAAI,eAAe,YAAY,QAAQ;AAEvCA,wBAAAA,MAAI,UAAU;AAAA,YACb,OAAO;AAAA,YACP,MAAM;AAAA,WACN;AAGD,qBAAW,MAAM;AAChBA,0BAAAA,MAAI,aAAa;AAAA,UACjB,GAAE,IAAI;AAAA,eACD;AACN,gBAAM,IAAI,MAAM,IAAI,OAAO,OAAO;AAAA,QACnC;AAAA,MAED,SAAS,GAAG;AACXA,sBAAAA,MAAc,MAAA,SAAA,+BAAA,WAAW,CAAC;AAC1BA,sBAAAA,MAAI,UAAU;AAAA,UACb,OAAO;AAAA,UACP,MAAM;AAAA,SACN;AAAA,MACF,UAAU;AACTA,sBAAAA,MAAI,YAAY;AAAA,MACjB;AAAA,IACD;AAAA,EACD;AACD;;;;;;;;;;ACxGA,GAAG,WAAW,eAAe;"}